# 1. Intro

Code in this repository will:
- start three VMs using Vagrant
- install muti-node Kubernetes cluster on these VMs
- allow to install local Helm chart with sample reverse proxy handling requests to origin http://ifconfig.me and replying with requestor IP address

Note: initially I planned to use http://ifconfig.co service, but it seems they have added CAPTCHA protection and request returned full HTML documents. So I changed to equivalent service withm .me extension

# 2. Prerequisites
You should run this code on a decent machine with at least 16 GB of RAM (8 GB might suffice but 4 GB is definitely not enough)

You should have installed locally recent versions (as per January 2021) of:
- Virtualbox (as a Vagrant provider)
- Vagrant
- kubectl
- Helm
- curl

# 3. Execution steps
1. cd to the cloned repository directory
2. run vagrant `vagrant up`
3. install local helm chart `helm install myrevproxy myrevproxy/ --values myrevproxy/values.yaml --kubeconfig shared/kubeconfig`
4. curl local machine IP with its NodePort exposed on port 32222. You can use local IP of any of the master/nodes, so any of these three commands should work
- master `curl 192.168.65.21:32222`
- node1 `curl 192.168.65.21:32222`
- node2 `curl 192.168.65.21:32222`
# 4. Implementation details 
## 4.1 Repository structure
- `myrevproxy` - directory containing simple helm chart with reverse proxy to `http://ifconfig.me`
- `scripts` - three scrips installing and condiguring kubernetes cluster on 3 Vagrant-managed VMs
- `shared` - directory that stores temporary files - script for nodes to join cluster master and kubeconfig file to authorize helm install to the cluster
- `Vagrantfile` - file creating VMs and executing bash scripts

## 4.2 Vagrant and Kubernetes setup

Process works as follows: 
- executes Vagrantfile that creates 3 VMs based on "ubuntu/xenial64" box (nodes named master, node1 and node2) 
- runs 3 shell scripts located in the "scripts" directory that

Scrips install and configure Kubernetes cluster

Master node will play the role of control plane. On the master node the scripts will:
- install Docker
- install kubernetes components (kubelet, kubeadm, kubectl)
- install Calico pod network
- generate master join command with kubeadm token and save it to local repo "shared" directory as master-join-command.sh file
- generate kubeconfig file and save it also to local repo "shared" directory (you will use it later)

On the worker nodes the scripts will:
- install Docker
- install kubernetes components (kubelet, kubeadm, kubectl)
- use script "shared/master-join-command.sh" to join worker node to master with 
## 3.2 Reverse proxy implementation
Local helm chart was created simply using `helm create myrevproxy` command and then a few configuration items were added.

Note that the install command:
`helm install myrevproxy myrevproxy/ --values myrevproxy/values.yaml --kubeconfig shared/kubeconfig`

- uses values defined in the helm chart `myrevproxy/values.yaml`
- utilizes `shared/kubeconfig` file generated by the cluster in the previous step to authenticate to the cluster
